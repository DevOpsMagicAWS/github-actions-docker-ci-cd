name: CI/CD Pipeline 

env:
  PYTHON_VERSION: '3.10'
  IMAGE_NAME: github-actions-demo
  PORT: 8080

on:
    push:
        branches: [ "main" ]
    pull_request:
        branches: [ "main" ]

jobs:
    build-test:
        runs-on: ubuntu-latest

        steps:
          - name: Checkout code
            uses: actions/checkout@v4

          - name: Set up Python
            uses: actions/setup-python@v5
            with:
              python-version: ${{ env.PYTHON_VERSION }}

          - name: Cache pip dependencies
            uses: actions/cache@v3
            with:
              path: ~/.cache/pip
              key: ${{ runner.os }}-pip-${{ hashFiles('app/requirements.txt') }}
              restore-keys: |
                ${{ runner.os }}-pip-

          - name: Install dependencies
            run: |
              pip install -r app/requirements.txt
              pip install pytest

          - name: Run tests
            run: pytest tests/

          - name: Security scan - Python dependencies
            run: |
              pip install safety
              safety check

          - name: Security scan - Code analysis
            run: |
              pip install bandit
              bandit -r app/ -f json -o bandit-report.json || true

          - name: Upload security reports
            uses: actions/upload-artifact@v4
            if: always()
            with:
              name: security-reports
              path: bandit-report.json

    docker-build:
      runs-on: ubuntu-latest
      needs: build-test

      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Build Docker image
          run: docker build -t ${{ env.IMAGE_NAME }} ./app

        - name: Security scan - Docker image
          run: |
            docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
              aquasec/trivy image --exit-code 0 --severity HIGH,CRITICAL \
              --format json --output trivy-report.json ${{ env.IMAGE_NAME }} || true

        - name: Upload Docker security report
          uses: actions/upload-artifact@v4
          if: always()
          with:
            name: docker-security-report
            path: trivy-report.json

        - name: Run container (test)
          run: |
            docker run --rm -d -p ${{ env.PORT }}:${{ env.PORT }} --name test-container ${{ env.IMAGE_NAME }}
            sleep 5
            if ! curl -f http://localhost:${{ env.PORT }}; then
              docker stop test-container || true
              exit 1
            fi
            docker stop test-container

    notify:
      runs-on: ubuntu-latest
      needs: [build-test, docker-build]
      if: always()
      steps:
        - name: Send Slack/Discord Notification
          env: 
            WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
            STATUS: ${{ needs.docker-build.result }}
          run: | 
            if [ -z "$WEBHOOK_URL" ]; then
              echo "WEBHOOK_URL not set, skipping notification"
              exit 0
            fi
            
            if [ "$STATUS" == "success" ]; then
              MESSAGE="✅ Pipeline succeeded on branch: ${{ github.ref_name }} - Commit: ${{ github.sha }}"
            else
              MESSAGE="❌ Pipeline failed on branch: ${{ github.ref_name }} - Commit: ${{ github.sha }}"
            fi

            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d "{\"content\": \"${MESSAGE}\", \"username\": \"Github Actions Bot\"}" \
                 $WEBHOOK_URL